version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: calendar_booking
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Unified Backend API
  # Includes: Core Calendar API + Doctor Portal + Admin Portal + Chatbot
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      # Database
      DATABASE_URL: postgresql+psycopg://postgres:postgres@postgres:5432/calendar_booking

      # Server
      PORT: 8000
      DEBUG: ${DEBUG:-false}
      DEFAULT_TIMEZONE: ${DEFAULT_TIMEZONE:-Asia/Kolkata}

      # Core API Auth
      SERVICE_API_KEY: ${SERVICE_API_KEY:-dev-api-key}
      API_KEY_RATE_LIMIT_PER_MINUTE: 120
      API_KEY_RATE_LIMIT_BURST: 30

      # Doctor Portal Auth
      DOCTOR_PORTAL_JWT_SECRET: ${DOCTOR_PORTAL_JWT_SECRET:-doctor-jwt-secret-dev}
      DOCTOR_PORTAL_JWT_ALGORITHM: HS256
      DOCTOR_PORTAL_OAUTH_CLIENT_ID: ${DOCTOR_PORTAL_OAUTH_CLIENT_ID:-}
      DOCTOR_PORTAL_OAUTH_CLIENT_SECRET: ${DOCTOR_PORTAL_OAUTH_CLIENT_SECRET:-}
      DOCTOR_PORTAL_OAUTH_REDIRECT_URI: ${DOCTOR_PORTAL_OAUTH_REDIRECT_URI:-http://localhost:8000/portal/auth/oauth/google/callback}
      DOCTOR_PORTAL_FRONTEND_CALLBACK_URL: ${DOCTOR_PORTAL_FRONTEND_CALLBACK_URL:-http://localhost:5173/doctor/oauth/callback}

      # Admin Portal Auth
      ADMIN_PORTAL_JWT_SECRET: ${ADMIN_PORTAL_JWT_SECRET:-admin-jwt-secret-dev}
      ADMIN_PORTAL_JWT_ALGORITHM: HS256
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@example.com}
      ADMIN_PASSWORD_HASH: ${ADMIN_PASSWORD_HASH:-}

      # Chatbot (OpenAI)
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4}
      OPENAI_TEMPERATURE: 0.7
      OPENAI_MAX_TOKENS: 500

      # Google Calendar (disabled by default for local dev)
      DISABLE_CALENDAR_WORKERS: ${DISABLE_CALENDAR_WORKERS:-true}
      GOOGLE_CALENDAR_CREDENTIALS_PATH: ${GOOGLE_CALENDAR_CREDENTIALS_PATH:-}
      GOOGLE_CALENDAR_DELEGATED_ADMIN_EMAIL: ${GOOGLE_CALENDAR_DELEGATED_ADMIN_EMAIL:-}

      # CORS
      CORS_ALLOW_ORIGINS: http://localhost:5173,http://localhost:3000
    ports:
      - "8000:8000"
    volumes:
      - ./credentials:/app/credentials:ro
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Unified Frontend
  # Includes: Chatbot + Doctor Portal + Admin Portal
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: http://localhost:8000
    ports:
      - "5173:80"
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
